name: Create Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Extract Release Notes from CHANGELOG
        id: changelog
        run: |
          # Get the version from the tag (e.g., v0.7.4 -> 0.7.4)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Extracting changelog for version: $VERSION"
          
          # Extract the section for this version from CHANGELOG.md
          # Looks for ## [X.Y.Z] or ## [vX.Y.Z] and captures until the next ## or end
          NOTES=$(awk -v ver="$VERSION" '
            BEGIN { found=0 }
            /^## \[v?'"$VERSION"'\]/ { found=1; next }
            /^## \[/ { if(found) exit }
            found { print }
          ' CHANGELOG.md)
          
          # If no notes found, use a default message
          if [ -z "$NOTES" ]; then
            NOTES="Release $VERSION"
            echo "No changelog entry found for version $VERSION, using default message"
          fi
          
          # Write to output file (handles multiline)
          echo "$NOTES" > release_notes.md
          echo "Release notes extracted successfully"
          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release_notes.md
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
